<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDP TOOLS - Admin Panel</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="light-beam"></div>
        <div class="light-beam"></div>
        <div class="light-beam"></div>
    </div>

    <!-- Header -->
    <header class="main-header">
        <div class="menu-icon" id="menuIcon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <a href="home.html" class="logo">LDP TOOLS</a>
        <div class="user-info">
            <span class="username" id="headerUsername">Admin</span>
            <div class="balance-box" id="headerBalance">‚àû</div>
        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <ul>
            <li onclick="window.location.href='home.html'">
                <i>üè†</i> Trang ch·ªß
            </li>
            <li onclick="window.location.href='#account'">
                <i>üë§</i> Ki·ªÉm tra t√†i kho·∫£n
            </li>
            <li onclick="window.location.href='deposit.html'">
                <i>üí∞</i> N·∫°p ti·ªÅn
            </li>
            <li onclick="showHistory()">
                <i>üìú</i> L·ªãch s·ª≠ mua
            </li>
            <li onclick="window.location.href='admin-panel.html'">
                <i>‚öôÔ∏è</i> Control Panel
            </li>
            <li onclick="logout()">
                <i>üö™</i> ƒêƒÉng xu·∫•t
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="admin-container">
            <div class="admin-header">
                <h1 class="admin-title">‚öôÔ∏è CONTROL PANEL</h1>
                <p class="admin-subtitle">Qu·∫£n l√Ω h·ªá th·ªëng LDP Tools</p>
            </div>

            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">T·ªïng ng∆∞·ªùi d√πng</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalKeys">0</div>
                    <div class="stat-label">Keys ƒë√£ t·∫°o</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeKeys">0</div>
                    <div class="stat-label">Keys ƒëang active</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRevenue">0ƒë</div>
                    <div class="stat-label">T·ªïng doanh thu</div>
                </div>
            </div>

            <!-- Admin Panels Grid -->
            <div class="admin-grid">
                <!-- User Management Panel -->
                <div class="admin-panel">
                    <div class="panel-header">
                        <div class="panel-icon">üë•</div>
                        <h3 class="panel-title">Danh S√°ch User</h3>
                    </div>
                    <div class="user-list" id="userList">
                        <div class="empty-state">
                            <div class="empty-icon">üë§</div>
                            <div class="empty-title">Ch∆∞a c√≥ ng∆∞·ªùi d√πng</div>
                        </div>
                    </div>
                </div>

                <!-- Create Key Panel -->
                <div class="admin-panel">
                    <div class="panel-header">
                        <div class="panel-icon">üîë</div>
                        <h3 class="panel-title">T·∫°o Key Tool</h3>
                    </div>
                    <form class="admin-form" id="keyForm">
                        <div class="form-group">
                            <label>T√™n t√†i kho·∫£n</label>
                            <input type="text" class="admin-input" id="keyUsername" placeholder="Nh·∫≠p username" required>
                        </div>
                        <div class="form-group">
                            <label>Ch·ªçn Tool</label>
                            <select class="admin-select" id="keyTool" required>
                                <option value="toolv1">Tool V1 - T√†i X·ªâu</option>
                                <option value="toolmd5">Tool MD5 - Gi·∫£i m√£</option>
                                <option value="toolsicbo">Tool Sicbo - 3 x√≠ ng·∫ßu</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Th·ªùi h·∫°n</label>
                            <select class="admin-select" id="keyDuration" required>
                                <option value="30min">30 ph√∫t - 10,000 VND</option>
                                <option value="2h">2 gi·ªù - 20,000 VND</option>
                                <option value="1day">1 ng√†y - 50,000 VND</option>
                                <option value="3days">3 ng√†y - 100,000 VND</option>
                                <option value="7days">7 ng√†y - 150,000 VND</option>
                            </select>
                        </div>
                        <button type="submit" class="submit-btn">üîë T·∫°o Key</button>
                    </form>
                </div>

                <!-- Keys List Panel -->
                <div class="admin-panel">
                    <div class="panel-header">
                        <div class="panel-icon">üìã</div>
                        <h3 class="panel-title">Danh S√°ch Keys</h3>
                    </div>
                    <div class="key-list" id="keyList">
                        <div class="empty-state">
                            <div class="empty-icon">üîë</div>
                            <div class="empty-title">Ch∆∞a c√≥ key n√†o</div>
                        </div>
                    </div>
                </div>

                <!-- Send Notification Panel -->
                <div class="admin-panel">
                    <div class="panel-header">
                        <div class="panel-icon">üì¢</div>
                        <h3 class="panel-title">G·ª≠i Th√¥ng B√°o</h3>
                    </div>
                    <form class="admin-form" id="notificationForm">
                        <div class="form-group">
                            <label>N·ªôi dung th√¥ng b√°o</label>
                            <textarea class="admin-input" id="notificationMessage" placeholder="Nh·∫≠p n·ªôi dung..." rows="4" required></textarea>
                        </div>
                        <button type="submit" class="submit-btn">üì¢ G·ª≠i th√¥ng b√°o</button>
                    </form>
                </div>

                <!-- System Management Panel -->
                <div class="admin-panel">
                    <div class="panel-header">
                        <div class="panel-icon">üîß</div>
                        <h3 class="panel-title">Qu·∫£n L√Ω H·ªá Th·ªëng</h3>
                    </div>
                    <div class="system-actions">
                        <button onclick="exportData()" class="action-btn">üì§ Export Data</button>
                        <button onclick="importData()" class="action-btn">üì• Import Data</button>
                        <button onclick="clearInactiveKeys()" class="action-btn warning">üóëÔ∏è X√≥a Keys H·∫øt H·∫°n</button>
                        <button onclick="resetSystem()" class="action-btn danger">üîÑ Reset H·ªá Th·ªëng</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Notification -->
    <div id="notification" class="notification">
        <div class="notification-icon">‚úì</div>
        <div class="notification-content">
            <div class="notification-title">Th√¥ng b√°o</div>
            <div class="notification-message">Message here</div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/auth.js"></script>
    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚öôÔ∏è Admin panel initializing...');

            // Check admin access
            const currentUser = checkAuth();
            if (!currentUser || !currentUser.isAdmin) {
                showNotification('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p admin panel!', 'error');
                setTimeout(() => {
                    window.location.href = 'home.html';
                }, 3000);
                return;
            }

            // Initialize UI
            initializeHeader();
            initializeSidebar();
            loadAdminData();

            // Setup form handlers
            setupFormHandlers();

            console.log('‚úÖ Admin panel ready');
        });

        // Setup form handlers
        function setupFormHandlers() {
            // Key creation form
            document.getElementById('keyForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createKey();
            });

            // Notification form
            document.getElementById('notificationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                sendNotification();
            });
        }

        // Load admin data
        function loadAdminData() {
            loadUsersList();
            loadKeysList();
            updateStats();
        }

        // Load users list
        function loadUsersList() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userList = document.getElementById('userList');

            // Filter out admin users for display
            const regularUsers = users.filter(u => !u.isAdmin);

            if (regularUsers.length === 0) {
                userList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë§</div>
                        <div class="empty-title">Ch∆∞a c√≥ ng∆∞·ªùi d√πng th∆∞·ªùng</div>
                    </div>
                `;
                return;
            }

            userList.innerHTML = '';
            regularUsers.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div class="user-details">
                        <div class="user-name">${user.username}</div>
                        <div class="user-date">ƒêƒÉng k√Ω: ${new Date(user.createdAt).toLocaleDateString('vi-VN')}</div>
                        <div class="user-tools">Tools active: ${countActiveTools(user.tools)}</div>
                    </div>
                    <div class="user-actions">
                        <button class="action-btn edit" onclick="editUser('${user.username}')">S·ª≠a</button>
                        <button class="action-btn delete" onclick="deleteUser('${user.username}')">X√≥a</button>
                    </div>
                `;
                userList.appendChild(userItem);
            });
        }

        // Load keys list
        function loadKeysList() {
            const keys = JSON.parse(localStorage.getItem('keys') || '[]');
            const keyList = document.getElementById('keyList');

            if (keys.length === 0) {
                keyList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîë</div>
                        <div class="empty-title">Ch∆∞a c√≥ key n√†o</div>
                    </div>
                `;
                return;
            }

            keyList.innerHTML = '';
            keys.forEach((key, index) => {
                const isExpired = key.expiry && new Date(key.expiry) < new Date();
                const isUsed = key.used;

                const keyItem = document.createElement('div');
                keyItem.className = 'key-item';
                keyItem.innerHTML = `
                    <div class="key-code">${key.key}</div>
                    <div class="key-info">
                        <span>User: ${key.username}</span>
                        <span>Tool: ${key.tool_name}</span>
                        <span>Duration: ${formatDuration(key.duration)}</span>
                    </div>
                    <div class="key-status">
                        <span class="status ${isUsed ? 'used' : isExpired ? 'expired' : 'active'}">
                            ${isUsed ? 'ƒê√£ d√πng' : isExpired ? 'H·∫øt h·∫°n' : 'Active'}
                        </span>
                    </div>
                    <button class="delete-key-btn" onclick="deleteKey(${index})">X√≥a</button>
                `;
                keyList.appendChild(keyItem);
            });
        }

        // Update statistics
        function updateStats() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const keys = JSON.parse(localStorage.getItem('keys') || '[]');

            const totalUsers = users.filter(u => !u.isAdmin).length;
            const totalKeys = keys.length;
            const activeKeys = keys.filter(k => !k.used && (!k.expiry || new Date(k.expiry) > new Date())).length;

            // Calculate revenue (simplified)
            const revenue = keys.filter(k => k.used).length * 10000; // Rough estimate

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalKeys').textContent = totalKeys;
            document.getElementById('activeKeys').textContent = activeKeys;
            document.getElementById('totalRevenue').textContent = formatCurrency(revenue);
        }

        // Create key
        function createKey() {
            const username = document.getElementById('keyUsername').value.trim();
            const toolName = document.getElementById('keyTool').value;
            const duration = document.getElementById('keyDuration').value;

            if (!username || !toolName || !duration) {
                showNotification('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            // Check if user exists
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userExists = users.some(u => u.username === username);

            if (!userExists) {
                showNotification('Ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i!', 'error');
                return;
            }

            // Generate key
            const key = generateKey(toolName, username, duration);

            showNotification(`‚úÖ Key ƒë√£ t·∫°o: ${key}`, 'success');

            // Reset form
            document.getElementById('keyForm').reset();

            // Reload data
            loadAdminData();
        }

        // Send notification
        function sendNotification() {
            const message = document.getElementById('notificationMessage').value.trim();

            if (!message) {
                showNotification('Vui l√≤ng nh·∫≠p n·ªôi dung th√¥ng b√°o!', 'error');
                return;
            }

            // Add to notifications
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            notifications.push({
                message: message,
                sender: 'admin',
                createdAt: new Date().toISOString(),
                sentTo: [] // In real implementation, this would be populated
            });

            localStorage.setItem('notifications', JSON.stringify(notifications));

            showNotification('‚úÖ Th√¥ng b√°o ƒë√£ ƒë∆∞·ª£c g·ª≠i!', 'success');

            // Reset form
            document.getElementById('notificationForm').reset();
        }

        // Generate key (simplified version)
        function generateKey(toolName, username, duration) {
            const keys = JSON.parse(localStorage.getItem('keys') || '[]');

            let key;
            do {
                key = 'LDP-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            } while (keys.some(k => k.key === key));

            const expiry = calculateExpiry(duration);

            const keyData = {
                key: key,
                tool_name: toolName,
                username: username,
                duration: duration,
                expiry: expiry,
                createdAt: new Date().toISOString(),
                used: false,
                usedAt: null
            };

            keys.push(keyData);
            localStorage.setItem('keys', JSON.stringify(keys));

            return key;
        }

        // Calculate expiry
        function calculateExpiry(duration) {
            const now = new Date();
            switch(duration) {
                case '30min': return new Date(now.getTime() + 30 * 60000).toISOString();
                case '2h': return new Date(now.getTime() + 2 * 3600000).toISOString();
                case '1day': return new Date(now.getTime() + 24 * 3600000).toISOString();
                case '3days': return new Date(now.getTime() + 3 * 24 * 3600000).toISOString();
                case '7days': return new Date(now.getTime() + 7 * 24 * 3600000).toISOString();
                default: return new Date(now.getTime() + 24 * 3600000).toISOString();
            }
        }

        // Count active tools
        function countActiveTools(tools) {
            if (!tools) return 0;
            return Object.values(tools).filter(tool => tool && tool.active).length;
        }

        // Edit user
        function editUser(username) {
            const newUsername = prompt(`Nh·∫≠p t√™n m·ªõi cho ${username}:`, username);
            if (newUsername && newUsername !== username) {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(u => u.username === username);

                if (userIndex !== -1) {
                    users[userIndex].username = newUsername;
                    localStorage.setItem('users', JSON.stringify(users));
                    showNotification(`‚úÖ ƒê√£ ƒë·ªïi t√™n th√†nh: ${newUsername}`);
                    loadAdminData();
                }
            }
        }

        // Delete user
        function deleteUser(username) {
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA user "${username}"?`)) {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const filteredUsers = users.filter(u => u.username !== username);

                localStorage.setItem('users', JSON.stringify(filteredUsers));
                showNotification(`‚úÖ ƒê√£ x√≥a user: ${username}`);
                loadAdminData();
            }
        }

        // Delete key
        function deleteKey(index) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a key n√†y?')) {
                const keys = JSON.parse(localStorage.getItem('keys') || '[]');
                keys.splice(index, 1);
                localStorage.setItem('keys', JSON.stringify(keys));
                showNotification('‚úÖ ƒê√£ x√≥a key');
                loadAdminData();
            }
        }

        // System management functions
        function exportData() {
            const data = {
                users: localStorage.getItem('users'),
                keys: localStorage.getItem('keys'),
                notifications: localStorage.getItem('notifications'),
                currentUser: localStorage.getItem('currentUser')
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `ldp-tools-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();

            URL.revokeObjectURL(url);
            showNotification('‚úÖ D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c export!');
        }

        function importData() {
            showNotification('T√≠nh nƒÉng import ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn...');
        }

        function clearInactiveKeys() {
            const keys = JSON.parse(localStorage.getItem('keys') || '[]');
            const now = new Date();
            const activeKeys = keys.filter(k => !k.used && (!k.expiry || new Date(k.expiry) > now));

            const removedCount = keys.length - activeKeys.length;
            localStorage.setItem('keys', JSON.stringify(activeKeys));

            showNotification(`‚úÖ ƒê√£ x√≥a ${removedCount} keys h·∫øt h·∫°n!`);
            loadAdminData();
        }

        function resetSystem() {
            if (confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: H√†nh ƒë·ªông n√†y s·∫Ω X√ìA T·∫§T C·∫¢ d·ªØ li·ªáu! B·∫°n c√≥ ch·∫Øc ch·∫Øn?')) {
                if (confirm('‚ùó X√ÅC NH·∫¨N L·∫¶N CU·ªêI: T·∫•t c·∫£ d·ªØ li·ªáu s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn!')) {
                    localStorage.clear();
                    showNotification('üîÑ H·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c reset!');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }
            }
        }

        // Show history (placeholder)
        function showHistory() {
            showNotification('T√≠nh nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn...');
        }
    </script>
</body>
</html>
